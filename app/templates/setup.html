<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Media Bot Setup</title>
    <style>
      :root {
        color-scheme: dark;
      }
      body {
        font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at top, #1e293b 0%, #0f172a 45%, #020617 100%);
        color: #e2e8f0;
      }
      .card {
        width: min(90vw, 560px);
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 18px;
        padding: 2.4rem;
        box-shadow: 0 24px 55px rgba(2, 6, 23, 0.65);
        background: rgba(15, 23, 42, 0.92);
        backdrop-filter: blur(14px);
      }
      h1 {
        font-size: clamp(1.5rem, 1.8vw + 1rem, 2rem);
        margin: 0 0 0.75rem;
        font-weight: 700;
        letter-spacing: 0.35px;
      }
      .subtitle {
        color: #cbd5f5;
        margin-bottom: 1.5rem;
        font-size: 1.02rem;
        line-height: 1.55;
      }
      form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      label {
        font-weight: 600;
        letter-spacing: 0.25px;
        margin-bottom: 0.35rem;
      }
      input[type="text"],
      input[type="password"] {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(15, 23, 42, 0.65);
        padding: 0.85rem 0.95rem;
        font-size: 1rem;
        color: #f8fafc;
        transition: border 0.2s ease, box-shadow 0.2s ease;
      }
      input[type="text"]:focus,
      input[type="password"]:focus {
        outline: none;
        border-color: rgba(96, 165, 250, 0.9);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
      }
      .hint {
        color: #94a3b8;
        font-size: 0.92rem;
        line-height: 1.4;
      }
      .error {
        background: rgba(239, 68, 68, 0.12);
        border: 1px solid rgba(248, 113, 113, 0.35);
        color: #fee2e2;
        padding: 0.9rem 1rem;
        border-radius: 12px;
        margin-bottom: 0.8rem;
        line-height: 1.4;
      }
      button {
        margin-top: 0.5rem;
        padding: 0.9rem 1rem;
        font-size: 1.05rem;
        background: linear-gradient(135deg, #16a34a, #22d3ee);
        color: #0f172a;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.3px;
        transition: transform 0.2s ease, box-shadow 0.2s ease, filter 0.2s ease;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 18px 45px rgba(45, 212, 191, 0.35);
        filter: brightness(1.05);
      }
      .foot {
        color: #94a3b8;
        font-size: 0.92rem;
        margin-top: 1.8rem;
        border-top: 1px solid rgba(148, 163, 184, 0.25);
        padding-top: 1.1rem;
        line-height: 1.5;
      }
      code {
        background: rgba(30, 41, 59, 0.9);
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        color: #f8fafc;
      }
      button:active {
        transform: translateY(0);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      .status-indicator {
        display: none;
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        text-align: center;
        font-weight: 500;
      }
      .status-indicator.active {
        display: block;
      }
      .status-indicator.connecting {
        background: rgba(59, 130, 246, 0.12);
        border: 1px solid rgba(96, 165, 250, 0.35);
        color: #93c5fd;
      }
      .status-indicator.success {
        background: rgba(34, 197, 94, 0.12);
        border: 1px solid rgba(74, 222, 128, 0.35);
        color: #86efac;
      }
      .status-indicator.error {
        background: rgba(239, 68, 68, 0.12);
        border: 1px solid rgba(248, 113, 113, 0.35);
        color: #fca5a5;
      }
      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(148, 163, 184, 0.3);
        border-top-color: currentColor;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        vertical-align: middle;
        margin-right: 8px;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      .wifi-list {
        margin-top: 1rem;
        margin-bottom: 1rem;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.6);
        padding: 0.5rem;
      }
      .wifi-item {
        padding: 0.75rem;
        margin: 0.25rem 0;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .wifi-item:hover {
        background: rgba(59, 130, 246, 0.15);
      }
      .wifi-item:active {
        background: rgba(59, 130, 246, 0.25);
      }
      .wifi-ssid {
        font-weight: 600;
        color: #e2e8f0;
        flex: 1;
      }
      .wifi-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.85rem;
        color: #94a3b8;
      }
      .wifi-signal {
        display: flex;
        align-items: center;
        gap: 0.25rem;
      }
      .wifi-lock {
        font-size: 0.9rem;
      }
      .scan-button {
        margin-top: 0.5rem;
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
        background: rgba(59, 130, 246, 0.2);
        color: #93c5fd;
        border: 1px solid rgba(96, 165, 250, 0.3);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        width: 100%;
      }
      .scan-button:hover {
        background: rgba(59, 130, 246, 0.3);
        border-color: rgba(96, 165, 250, 0.5);
      }
      .scan-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      @media (max-width: 520px) {
        .card {
          padding: 1.75rem 1.25rem;
          width: 95vw;
        }
        h1 {
          font-size: 1.4rem;
        }
        .subtitle {
          font-size: 0.95rem;
        }
        input[type="text"],
        input[type="password"] {
          padding: 0.95rem 1rem;
          font-size: 16px; /* Prevents zoom on iOS */
        }
        button {
          padding: 1rem;
          font-size: 1.1rem;
          min-height: 48px; /* Better touch target */
        }
        .hint {
          font-size: 0.88rem;
        }
        .foot {
          font-size: 0.85rem;
        }
      }
      @media (max-width: 380px) {
        .card {
          padding: 1.5rem 1rem;
        }
        h1 {
          font-size: 1.25rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Step 2 ¬∑ Connect the Media Bot</h1>
      <p class="subtitle">
        Enter the Wi‚ÄëFi credentials for your home network and the Telegram bot token from <a href="https://t.me/BotFather" target="_blank" rel="noreferrer">BotFather</a>.
        The device will switch from the setup hotspot to your home Wi‚ÄëFi after a successful connection.
      </p>
      {{ERROR_BOX}}
      <div id="status-indicator" class="status-indicator"></div>
      <form id="setup-form" method="POST" action="/submit">
        <div>
          <label for="wifi_ssid">Home Wi‚ÄëFi Name (SSID)</label>
          <input id="wifi_ssid" name="wifi_ssid" type="text" placeholder="HomeNetwork" value="{{WIFI_SSID}}" required>
          <button type="button" id="scan-wifi-btn" class="scan-button">üì° Scan for Wi‚ÄëFi Networks</button>
          <div id="wifi-list" class="wifi-list" style="display: none;"></div>
        </div>
        <div>
          <label for="wifi_password">Home Wi‚ÄëFi Password</label>
          <input id="wifi_password" name="wifi_password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="{{WIFI_PASSWORD}}" required>
        </div>
        <div>
          <label for="token">Telegram Bot Token</label>
          <input id="token" name="token" type="text" placeholder="123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11" value="{{TOKEN}}" required>
          <div class="hint">Tip: send <code>/token</code> to BotFather if you need to regenerate it.</div>
        </div>
        <button type="submit" id="submit-btn">Save &amp; Connect</button>
      </form>
      <div class="foot">
        ‚Ä¢ The Media Bot will reboot its Wi‚ÄëFi connection after you submit.<br>
        ‚Ä¢ If the connection fails, the setup hotspot will return and you can try again.<br>
        ‚Ä¢ Credentials are stored securely in your <code>.env</code> file on the device.
      </div>
    </div>
    <script>
      (function() {
        const form = document.getElementById('setup-form');
        const submitBtn = document.getElementById('submit-btn');
        const statusIndicator = document.getElementById('status-indicator');
        let pollInterval = null;
        
        function showStatus(message, type) {
          statusIndicator.innerHTML = message;
          statusIndicator.className = 'status-indicator active ' + type;
        }
        
        function hideStatus() {
          statusIndicator.className = 'status-indicator';
        }
        
        // Wi‚ÄëFi scanning functionality
        const scanBtn = document.getElementById('scan-wifi-btn');
        const wifiList = document.getElementById('wifi-list');
        const wifiSsidInput = document.getElementById('wifi_ssid');
        
        function getSignalBars(signal) {
          const strength = parseInt(signal) || 0;
          if (strength >= 75) return '‚ñÇ‚ñÑ‚ñÜ‚ñà';
          if (strength >= 50) return '‚ñÇ‚ñÑ‚ñÜ‚ñÅ';
          if (strength >= 25) return '‚ñÇ‚ñÑ‚ñÅ‚ñÅ';
          return '‚ñÇ‚ñÅ‚ñÅ‚ñÅ';
        }
        
        function renderWifiList(networks) {
          if (networks.length === 0) {
            wifiList.innerHTML = '<div style="padding: 1rem; text-align: center; color: #94a3b8;">No networks found</div>';
            wifiList.style.display = 'block';
            return;
          }
          
          wifiList.innerHTML = networks.map(network => {
            const signalBars = getSignalBars(network.signal);
            const lockIcon = network.security && network.security !== '--' ? 'üîí' : '';
            return `
              <div class="wifi-item" data-ssid="${network.ssid.replace(/"/g, '&quot;')}">
                <span class="wifi-ssid">${network.ssid}</span>
                <div class="wifi-info">
                  <span class="wifi-signal" title="${network.signal}%">${signalBars}</span>
                  ${lockIcon ? `<span class="wifi-lock">${lockIcon}</span>` : ''}
                </div>
              </div>
            `;
          }).join('');
          
          wifiList.style.display = 'block';
          
          // Add click handlers
          wifiList.querySelectorAll('.wifi-item').forEach(item => {
            item.addEventListener('click', () => {
              const ssid = item.getAttribute('data-ssid');
              wifiSsidInput.value = ssid;
              wifiSsidInput.focus();
              // Highlight the selected item briefly
              item.style.background = 'rgba(34, 197, 94, 0.2)';
              setTimeout(() => {
                item.style.background = '';
              }, 500);
            });
          });
        }
        
        scanBtn.addEventListener('click', async () => {
          scanBtn.disabled = true;
          scanBtn.textContent = 'üîÑ Scanning...';
          
          try {
            const response = await fetch('/scan-wifi');
            const data = await response.json();
            renderWifiList(data.networks || []);
          } catch (error) {
            console.error('Scan error:', error);
            wifiList.innerHTML = '<div style="padding: 1rem; text-align: center; color: #fca5a5;">Error scanning for networks</div>';
            wifiList.style.display = 'block';
          } finally {
            scanBtn.disabled = false;
            scanBtn.textContent = 'üì° Scan for Wi‚ÄëFi Networks';
          }
        });
        
        function startPolling() {
          let pollCount = 0;
          const maxPolls = 60; // 60 seconds max
          
          pollInterval = setInterval(async () => {
            pollCount++;
            if (pollCount > maxPolls) {
              clearInterval(pollInterval);
              showStatus('Connection timeout. Please check your Wi‚ÄëFi credentials and try again.', 'error');
              submitBtn.disabled = false;
              return;
            }
            
            try {
              const response = await fetch('/status');
              const data = await response.json();
              
              if (data.status === 'success') {
                clearInterval(pollInterval);
                showStatus('‚úÖ Connected successfully! Redirecting...', 'success');
                setTimeout(() => {
                  window.location.href = '/success';
                }, 1500);
              } else if (data.status === 'error') {
                clearInterval(pollInterval);
                showStatus('‚ùå ' + (data.message || 'Connection failed. Please check your credentials.'), 'error');
                submitBtn.disabled = false;
              } else if (data.status === 'connecting') {
                const message = data.message || 'Connecting to Wi‚ÄëFi network...';
                showStatus('<span class="spinner"></span>' + message, 'connecting');
              } else {
                // Still connecting, show default message
                showStatus('<span class="spinner"></span>Connecting to Wi‚ÄëFi network...', 'connecting');
              }
            } catch (error) {
              console.error('Polling error:', error);
              // Continue polling on network errors
            }
          }, 1000);
        }
        
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          submitBtn.disabled = true;
          hideStatus();
          
          const formData = new FormData(form);
          
          try {
            const response = await fetch('/submit', {
              method: 'POST',
              body: formData
            });
            
            const contentType = response.headers.get('content-type') || '';
            
            if (response.ok && contentType.includes('application/json')) {
              // Success - start polling
              showStatus('<span class="spinner"></span>Connecting to Wi‚ÄëFi network...', 'connecting');
              startPolling();
            } else {
              // Error - show error message or reload page
              if (contentType.includes('text/html')) {
                // HTML error response - reload to show error
                window.location.reload();
              } else {
                // Try to parse as JSON for error message
                try {
                  const errorData = await response.json();
                  showStatus('‚ùå ' + (errorData.message || 'An error occurred. Please try again.'), 'error');
                } catch {
                  showStatus('‚ùå An error occurred. Please try again.', 'error');
                }
                submitBtn.disabled = false;
              }
            }
          } catch (error) {
            console.error('Submit error:', error);
            showStatus('‚ùå Network error. Please try again.', 'error');
            submitBtn.disabled = false;
          }
        });
      })();
    </script>
  </body>
</html>


